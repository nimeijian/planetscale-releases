## Running Vitess with your existing mySQL database


### Overview:
This is an example for establishing a very simple single-vttablet Vitess cluster in conjunction with an existing mysql database.  Essentially it addresses the question "How can I apply Vitess technology to my existing (and running!) database without import/export or other data transformation mechanisms?"

If you are not familiar with Vitess, We recommend you first work through the [Tutorial](https://vitess.io/docs/tutorials/local/) documentation for a "fresh" [local deployment](https://vitess.io/docs/tutorials/local/)(no-pre-existing database).  
The same prerequisites and installs for that tutorial are required to run this example.

This example starts with an instance of an "Unmanaged or remote MySQL", and will be later expanded to include variations on "Paritially Managed MySQL".  Further information on these modes can be found at [VTTablet Modes](https://vitess.io/docs/user-guides/vttablet-modes).

The example itself is a series of scripts derived from those that are generated by [deployment_helper.py](https://github.com/jvaidya/vitess-tools/tree/master/deployment_helper).  Here the scripts are hard-coded for local deployment only on a single host responding to 'localhost', and work with a single mysqld instance on this same host.
We invite you to examine these scripts as you run them to understand their function and how they are paramterized.  They are summarized here, but follow the steps further below before executing them.

*  `zk-external-up.sh`

 Establishes the lockserver quorum that Vitess components synchronize on. 

 Three instances of zookeeper are required to successfully establish the quorum.  For this example, all three are started on `localhost`.

 At the end, the zookeeper contents are listed via a `vtctl` command, issued directly to your local server.


*  `vtctld-external-up.sh`

 Establishes the Vitess "control plane" daemon on port `15999`


* `vttablet-external-up.sh`

 Establishes the Vitess "serving plane" on port `15201` 


* `vtgate-external-up.sh`

 Provides the "serving plane" *query interface* on port `15306`, for Vitess client access over mysql protocol.

All scripts should be set as executable (e.g. `chmod 770`)



### Stepwise:
1.  Ensure the network name 'localhost' resolves to 127.0.0.1, e.g, in /etc/hosts

2.  Make sure a mysqld instance is running locally:
 - mysqld should be started or modified to enforce sql-mode=STRICT_TRANS_TABLES  (Editor note: there are also flags for starting vttablet to ignore this requirement.  We'll document those here in future.)  
 - The startup output should report something similar to the following:
 ```
 (timestamp)[Note] Server hostname (bind-address): '127.0.0.1'; port: 3306
 (timestamp)[[Note]   - '127.0.0.1' resolves to '127.0.0.1';
 (timestamp)[[Note] Server socket created on IP: '127.0.0.1'.
```
 - The mysqld instance should implement a database named _**commerce**_ (following our example database naming).
 - Access to the commerce database should be granted to _**user=chrisr**_, _**password=chrisr**_, e.g., via this command:

		`GRANT ALL PRIVILEGES ON commerce.* TO 'ext_user'@'localhost' identified by 'ext_password';`

3.  Establish a vitess topology with zookeeper:

	`./zk-external-up.sh`

    Should yield the following output (other informational/debug output will also be emitted):
```
Starting zk servers...
Started zk server 1
Started zk server 2
Started zk server 3
...
```
    The final command in that script is:
    `./vtctl $TOPOLOGY_FLAGS GetCellInfoNames`

    which should yield:

    `cell1`  

4.  Start vtctld which provides the "control plane" functionality of vitess.

 **Note** that the environment variable VTDATATROOT is set in the script as ${HOME}/vtdataroot.  Modify as needed.

    `./vtctld-external-up.sh`

    As noted in the output, you can access the Vitess Control Panel at [http://localhost:15000](http://localhost:15000)  


5.  Start the vttablet that is to be associated with your mysqld:

    This script establishes a `commerce` keyspace that matches the `commerce` mysqld instance, using the example of our [Tutorial](https://vitess.io/docs/tutorials/local/).  
    **IMPORTANT**: You can modify this script to match the naming of your *actual* database, and permissions.

    `./vttablet-external-up.sh`

    You can check the status of this vttablet at [http://localhost:15201/debug/status](http://localhost:15201/debug/status)  


6.  **BEFORE** starting vtgate, you need to designate your vttablet as a Vitess 'master' before it can actually serve requests.
    The Vitess Control Panel page [http://localhost:15000/app2/shard?keyspace=commerce&shard=0](http://localhost:15000/app2/shard?keyspace=commerce&shard=0) will show that the vttablet instance is initially of type *`replica`*
    
    The command to issue is:

    `vtctlclient -server localhost:15999 TabletExternallyReparented cell1-0000000100`

    **Note:** No output is generated if successful.  Refresh the Vitess Control Panel page [http://localhost:15000/app2/shard?keyspace=commerce&shard=0](http://localhost:15000/app2/shard?keyspace=commerce&shard=0) to assure yourself that the instance has been promoted to *master* .

	**IMPORTANT** Under broader circumstances where you have multiple mysqld's (e.g., one is a mysql master with one or more replicas), you would start multiple vttablets "in front" of each of them.  Vitess would consider them all replicas, until you provided the alternate command to initiate one of them as the Shard Master, as follows:

	`vtctlclient -server localhost:15999 TabletExternallyReparented -force commerce/0 cell1-0000000100`

  
7.  Finally, start vtgate:

    `./vtgate-external-up.sh`

    You can check the status of vtgate at [http://localhost:15001/debug/status](http://localhost:15001/debug/status) 


8.  If you've made it this far :-) you should be able to access vtgate:

	`mysql -h 127.0.0.1 -P 15306 -umysql_user -pmysql_password -D commerce`

	From here, if you have kept the 'commerce' name for your keyspace and that matches your actual mysql database name, you can apply the SQL schema and Vitess Vschema file artifacts as described in the [Tutorial](https://vitess.io/docs/tutorials/local/) down to and including the initial [Vschema](https://vitess.io/docs/tutorials/local/#vschema) section. 


## Going forward...

To go beyond this, and implement further sharding as described in the Tutorial, you will need additional vttablets and backing mysqld's. We will cover that in future as an expansion of this guide. 



